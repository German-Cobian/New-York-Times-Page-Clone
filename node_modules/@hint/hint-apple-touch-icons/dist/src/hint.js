"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const image_size_1 = require("image-size");
const utils_string_1 = require("@hint/utils-string");
const utils_network_1 = require("@hint/utils-network");
const utils_debug_1 = require("@hint/utils-debug");
const utils_types_1 = require("@hint/utils-types");
const meta_1 = require("./meta");
const i18n_import_1 = require("./i18n.import");
const debug = utils_debug_1.debug(__filename);
class AppleTouchIconsHint {
    constructor(context) {
        const getAppleTouchIcons = (elements) => {
            return elements.filter((element) => {
                const relValue = element.getAttribute('rel');
                if (relValue === null) {
                    return false;
                }
                const relValues = utils_string_1.normalizeString(relValue).split(' ');
                return relValues.includes('apple-touch-icon') || relValues.includes('apple-touch-icon-precomposed');
            });
        };
        const checkImage = async (appleTouchIcon, resource) => {
            const appleTouchIconHref = utils_string_1.normalizeString(appleTouchIcon.getAttribute('href'));
            if (!appleTouchIconHref) {
                const message = i18n_import_1.getMessage('noEmptyHref', context.language);
                context.report(resource, message, { element: appleTouchIcon, severity: utils_types_1.Severity.error });
                return;
            }
            if (!utils_network_1.isRegularProtocol(resource)) {
                return;
            }
            const appleTouchIconURL = appleTouchIcon.resolveUrl(appleTouchIconHref);
            let networkData;
            try {
                networkData = await context.fetchContent(appleTouchIconURL);
            }
            catch (e) {
                debug(`Failed to fetch the ${appleTouchIconHref} file`);
                const message = i18n_import_1.getMessage('couldNotBeFetch', context.language);
                context.report(resource, message, { element: appleTouchIcon, severity: utils_types_1.Severity.error });
                return;
            }
            const response = networkData.response;
            if (response.statusCode !== 200) {
                const message = i18n_import_1.getMessage('couldNotBeFetchErrorStatusCode', context.language, response.statusCode.toString());
                context.report(resource, message, { element: appleTouchIcon, severity: utils_types_1.Severity.error });
                return;
            }
            let image;
            try {
                image = image_size_1.imageSize(response.body.rawContent);
            }
            catch (e) {
                if (e instanceof TypeError) {
                    const message = i18n_import_1.getMessage('invalidPNG', context.language);
                    context.report(resource, message, { element: appleTouchIcon, severity: utils_types_1.Severity.error });
                }
                else {
                    debug(`'getImageData' failed for '${appleTouchIconURL}'`);
                }
                return;
            }
            if (image.type !== 'png') {
                const message = i18n_import_1.getMessage('shouldBePNG', context.language);
                context.report(resource, message, { element: appleTouchIcon, severity: utils_types_1.Severity.error });
            }
            if (image.width !== 180 || image.height !== 180) {
                const message = i18n_import_1.getMessage('wrongResolution', context.language);
                context.report(resource, message, { element: appleTouchIcon, severity: utils_types_1.Severity.warning });
            }
        };
        const chooseBestIcon = (icons) => {
            let bestIcon;
            for (const icon of icons) {
                const sizes = utils_string_1.normalizeString(icon.getAttribute('sizes'));
                if (sizes === '180x180') {
                    return icon;
                }
                else if (!sizes) {
                    bestIcon = icon;
                }
            }
            return bestIcon || icons[0];
        };
        const validate = async ({ resource }) => {
            const pageDOM = context.pageDOM;
            const appleTouchIcons = getAppleTouchIcons(pageDOM.querySelectorAll('link'));
            const linksToManifest = pageDOM.querySelectorAll('link[rel="manifest"]').length > 0;
            if (appleTouchIcons.length === 0) {
                if (linksToManifest) {
                    context.report(resource, i18n_import_1.getMessage('noElement', context.language), { severity: utils_types_1.Severity.error });
                }
                return;
            }
            const appleTouchIcon = chooseBestIcon(appleTouchIcons);
            if (utils_string_1.normalizeString(appleTouchIcon.getAttribute('rel')) !== 'apple-touch-icon') {
                const message = i18n_import_1.getMessage('wrongRelAttribute', context.language);
                context.report(resource, message, { element: appleTouchIcon, severity: utils_types_1.Severity.warning });
            }
            if (appleTouchIcon.getAttribute('sizes')) {
                const message = i18n_import_1.getMessage('sizesAttribute', context.language);
                context.report(resource, message, { element: appleTouchIcon, severity: utils_types_1.Severity.warning });
            }
            await checkImage(appleTouchIcon, resource);
            const bodyAppleTouchIcons = getAppleTouchIcons(pageDOM.querySelectorAll('body link'));
            for (const icon of bodyAppleTouchIcons) {
                if (icon.isSame(appleTouchIcon)) {
                    const message = i18n_import_1.getMessage('elementNotInHead', context.language);
                    context.report(resource, message, { element: appleTouchIcon, severity: utils_types_1.Severity.error });
                }
            }
            for (const icon of appleTouchIcons) {
                if (!icon.isSame(appleTouchIcon)) {
                    const message = i18n_import_1.getMessage('elementDuplicated', context.language);
                    context.report(resource, message, { element: icon, severity: utils_types_1.Severity.warning });
                }
            }
        };
        context.on('traverse::end', validate);
    }
}
exports.default = AppleTouchIconsHint;
AppleTouchIconsHint.meta = meta_1.default;
